<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ACP 재단 - Azoral Contail Porn Foundation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { background: #222; color: #eee; font-family: 'Malgun Gothic', Arial, sans-serif; margin:0; }
    header { background:#111; padding:24px 0 10px; text-align:center; border-bottom:4px solid #f44;}
    header h1{ margin:0; font-size:2.3em; }
    header h2{ margin:11px 0 0 0; color:#f44; font-size:1.1em;}
    .container { max-width:900px; margin:30px auto; padding:24px; background:#292929; border-radius:8px; }
    .hidden { display:none; }
    nav { background:#191919; padding:7px 0; text-align:center; border-bottom:2px solid #444; }
    nav button { background:none; border:none; color:#f44; margin:0 10px; font-size:1.1em; cursor:pointer; }
    .board-post, .comment { background:#181818; margin:18px 0; padding:14px 12px; border-left:5px solid #f44; border-radius:6px; }
    .board-post .title { font-size:1.18em; color:#fff; margin-bottom:7px;}
    .like-btn { cursor:pointer; color:#f44; background: none; border: none; font-size:1.1em;}
    .like-btn.liked { color:#ffd700; }
    .comment { margin-left: 30px; border-left: 3px solid #4af; }
    .profile-box { margin:20px 0; padding:15px; background:#181818; border-radius:8px;}
    input, textarea { background:#222; color:#eee; border:1px solid #444; border-radius:4px; padding:6px 8px; margin-bottom:8px;}
    .login-box, .signup-box { margin:30px auto 0 auto; max-width:350px; background:#191919; padding:20px 22px; border-radius:10px;}
    .btn { background:#f44; color:#fff; border:none; padding:7px 15px; border-radius:5px; cursor:pointer;}
    .btn:disabled { background:#555; }
    .err { color:#f44; margin:7px 0;}
  </style>
</head>
<body>
  <header>
    <h1>ACP 재단</h1>
    <h2>Azoral Contail Porn Foundation</h2>
  </header>
  <nav id="navbar" class="hidden">
    <button onclick="showPage('board')">게시판</button>
    <button onclick="showPage('profile')">프로필</button>
    <button onclick="firebase.auth().signOut()">로그아웃</button>
  </nav>
  <div class="container">
    <!-- 로그인/회원가입 -->
    <div id="login-page" class="login-box">
      <h3>로그인</h3>
      <div>
        <input id="login-email" type="email" placeholder="이메일"><br>
        <input id="login-password" type="password" placeholder="비밀번호"><br>
        <button class="btn" onclick="login()">로그인</button>
        <button class="btn" onclick="showSignup()">회원가입</button>
      </div>
      <div id="login-error" class="err"></div>
    </div>
    <div id="signup-page" class="signup-box hidden">
      <h3>회원가입</h3>
      <div>
        <input id="signup-email" type="email" placeholder="이메일"><br>
        <input id="signup-password" type="password" placeholder="비밀번호"><br>
        <input id="signup-nickname" type="text" placeholder="닉네임"><br>
        <button class="btn" onclick="signup()">가입하기</button>
        <button class="btn" onclick="showLogin()">뒤로가기</button>
      </div>
      <div id="signup-error" class="err"></div>
    </div>
    <!-- 게시판 -->
    <div id="board-page" class="hidden">
      <h3>게시판</h3>
      <form id="post-form" onsubmit="createPost(event)" style="margin-bottom:18px;">
        <input id="post-title" type="text" placeholder="제목" required style="width:200px;">
        <textarea id="post-content" placeholder="내용" required rows="2" style="width:60%;"></textarea>
        <button class="btn" type="submit">글쓰기</button>
      </form>
      <div id="posts-list"></div>
    </div>
    <!-- 프로필 -->
    <div id="profile-page" class="profile-box hidden">
      <h3>프로필</h3>
      <div>
        <b>이메일:</b> <span id="profile-email"></span><br>
        <b>닉네임:</b> <input id="profile-nickname" type="text" style="width:140px;">
        <button class="btn" onclick="updateProfile()">수정</button><br>
        <b>자기소개:</b><br>
        <textarea id="profile-bio" rows="2" style="width:70%;"></textarea>
        <button class="btn" onclick="updateProfile()">수정</button>
      </div>
      <div id="profile-update-msg" style="color:#4af;"></div>
    </div>
  </div>
  <!-- Firebase 및 기능 스크립트 -->
  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCC6MFueLsHU1oZnM0Q3mvm_sU_tMPie8c",
      authDomain: "gaysdogam.firebaseapp.com",
      projectId: "gaysdogam",
      storageBucket: "gaysdogam.firebasestorage.app",
      messagingSenderId: "505108692237",
      appId: "1:505108692237:web:1e7bf3d6f855db7b238444",
      measurementId: "G-MCNTRDN70C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 페이지 전환
    function showPage(page) {
      document.getElementById('board-page').classList.add('hidden');
      document.getElementById('profile-page').classList.add('hidden');
      if(page==='board') loadPosts();
      if(page==='profile') loadProfile();
      document.getElementById(page+'-page').classList.remove('hidden');
    }
    function showSignup() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('signup-page').classList.remove('hidden');
    }
    function showLogin() {
      document.getElementById('signup-page').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
    }

    // 로그인/회원가입 로직
    function login() {
      const email = document.getElementById('login-email').value;
      const pw = document.getElementById('login-password').value;
      document.getElementById('login-error').textContent = '';
      firebase.auth().signInWithEmailAndPassword(email, pw)
        .catch(e=>{document.getElementById('login-error').textContent=e.message;});
    }
    function signup() {
      const email = document.getElementById('signup-email').value;
      const pw = document.getElementById('signup-password').value;
      const nick = document.getElementById('signup-nickname').value;
      document.getElementById('signup-error').textContent = '';
      firebase.auth().createUserWithEmailAndPassword(email, pw)
        .then(user=>{
          return db.collection('users').doc(user.user.uid).set({ nickname:nick, bio:'', email:email });
        })
        .then(()=>{ showLogin(); alert('회원가입 완료! 로그인해주세요.'); })
        .catch(e=>{document.getElementById('signup-error').textContent=e.message;});
    }

    // 인증 상태 변경 감지
    firebase.auth().onAuthStateChanged(user=>{
      if(user){
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('signup-page').classList.add('hidden');
        document.getElementById('navbar').classList.remove('hidden');
        showPage('board');
      }else{
        document.getElementById('navbar').classList.add('hidden');
        document.getElementById('board-page').classList.add('hidden');
        document.getElementById('profile-page').classList.add('hidden');
        document.getElementById('login-page').classList.remove('hidden');
      }
    });

    // 게시판: 글 작성
    function createPost(e) {
      e.preventDefault();
      const title = document.getElementById('post-title').value;
      const content = document.getElementById('post-content').value;
      const user = firebase.auth().currentUser;
      db.collection('users').doc(user.uid).get().then(doc=>{
        const nick = doc.exists ? doc.data().nickname : '익명';
        return db.collection('posts').add({
          title, content, uid:user.uid, nickname:nick, created:Date.now(), likes:[], comments:0
        });
      }).then(()=>{
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        loadPosts();
      });
    }

    // 게시판: 글 목록 불러오기
    function loadPosts() {
      const postList = document.getElementById('posts-list');
      postList.innerHTML = '<i>불러오는 중...</i>';
      db.collection('posts').orderBy('created','desc').limit(30).get().then(snap=>{
        postList.innerHTML = '';
        if(snap.empty){ postList.innerHTML = '<i>게시글이 없습니다.</i>'; return; }
        snap.forEach(doc=>{
          const p = doc.data();
          postList.innerHTML += `
          <div class="board-post" id="post-${doc.id}">
            <div class="title">${escapeHtml(p.title)} <span style="font-size:0.8em;color:#aaa;">by ${escapeHtml(p.nickname)}</span></div>
            <div>${escapeHtml(p.content)}</div>
            <div>
              <button class="like-btn" onclick="toggleLike('${doc.id}', this)">&#128077; <span>${p.likes.length||0}</span></button>
              <span style="margin-left:20px;">댓글 ${p.comments||0}개</span>
              <button class="btn" style="margin-left:20px;" onclick="toggleComments('${doc.id}')">댓글 보기</button>
            </div>
            <div class="comments-box hidden" id="comments-${doc.id}">
              <form onsubmit="addComment(event, '${doc.id}')">
                <input type="text" placeholder="댓글" id="comment-input-${doc.id}" required style="width:60%;">
                <button class="btn" type="submit">작성</button>
              </form>
              <div class="comment-list" id="comment-list-${doc.id}"></div>
            </div>
          </div>`;
          setTimeout(()=>updateLikeBtn(doc.id, p.likes),100);
        });
      });
    }

    // 좋아요 기능
    function toggleLike(postId, btn) {
      const user = firebase.auth().currentUser;
      const postRef = db.collection('posts').doc(postId);
      postRef.get().then(doc=>{
        if(!doc.exists) return;
        let likes = doc.data().likes || [];
        const idx = likes.indexOf(user.uid);
        if(idx===-1) likes.push(user.uid);
        else likes.splice(idx,1);
        postRef.update({likes});
        updateLikeBtn(postId, likes);
        btn.querySelector('span').textContent = likes.length;
        btn.classList.toggle('liked', idx===-1);
      });
    }
    function updateLikeBtn(postId, likes) {
      const user = firebase.auth().currentUser;
      const btn = document.querySelector(`#post-${postId} .like-btn`);
      if(btn && user) btn.classList.toggle('liked', (likes||[]).includes(user.uid));
    }

    // 댓글 보기/숨기기
    function toggleComments(postId) {
      const box = document.getElementById('comments-'+postId);
      if(box.classList.contains('hidden')) {
        box.classList.remove('hidden');
        loadComments(postId);
      } else {
        box.classList.add('hidden');
      }
    }
    // 댓글 불러오기
    function loadComments(postId) {
      const list = document.getElementById('comment-list-'+postId);
      db.collection('posts').doc(postId).collection('comments')
        .orderBy('created').get().then(snap=>{
        list.innerHTML = '';
        snap.forEach(doc=>{
          const c = doc.data();
          list.innerHTML += `<div class="comment"><b>${escapeHtml(c.nickname)}</b>: ${escapeHtml(c.text)}</div>`;
        });
      });
    }
    // 댓글 작성
    function addComment(e, postId) {
      e.preventDefault();
      const input = document.getElementById('comment-input-'+postId);
      const text = input.value;
      const user = firebase.auth().currentUser;
      db.collection('users').doc(user.uid).get().then(doc=>{
        const nick = doc.exists ? doc.data().nickname : '익명';
        return db.collection('posts').doc(postId).collection('comments').add({
          uid:user.uid, nickname:nick, text, created:Date.now()
        });
      }).then(()=>{
        input.value = '';
        loadComments(postId);
        // 댓글 수 증가
        const postRef = db.collection('posts').doc(postId);
        postRef.update({comments:firebase.firestore.FieldValue.increment(1)});
        loadPosts();
      });
    }

    // 프로필 보기 및 수정
    function loadProfile() {
      const user = firebase.auth().currentUser;
      document.getElementById('profile-email').textContent = user.email;
      db.collection('users').doc(user.uid).get().then(doc=>{
        const d = doc.data();
        document.getElementById('profile-nickname').value = d.nickname || '';
        document.getElementById('profile-bio').value = d.bio || '';
      });
      document.getElementById('profile-update-msg').textContent = '';
    }
    function updateProfile() {
      const user = firebase.auth().currentUser;
      const nickname = document.getElementById('profile-nickname').value;
      const bio = document.getElementById('profile-bio').value;
      db.collection('users').doc(user.uid).update({nickname, bio}).then(()=>{
        document.getElementById('profile-update-msg').textContent='저장되었습니다.';
        loadPosts();
      });
    }

    // HTML 이스케이프
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }
  </script>
</body>
</html>
